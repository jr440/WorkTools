<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Duct Calculator</title>
    <style>
        :root {
            /* Light Theme - Clean Professional */
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --accent-color: #4299e1;
            --accent-secondary: #3182ce;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --success-bg: #f0fff4;
            --success-border: #38a169;
            --success-text: #2f855a;
            --error-bg: #fed7d7;
            --error-border: #e53e3e;
            --error-text: #c53030;
        }

        [data-theme="dark"] {
            /* Dark Theme - Modern Professional */
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-secondary: #1a202c;
            --bg-tertiary: #2d3748;
            --bg-card: #2d3748;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --accent-color: #63b3ed;
            --accent-secondary: #4299e1;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.4);
            --success-bg: #1a202c;
            --success-border: #48bb78;
            --success-text: #68d391;
            --error-bg: #1a202c;
            --error-border: #f56565;
            --error-text: #fc8181;
        }

        [data-theme="midnight"] {
            /* Midnight Theme - Ultra Professional */
            --bg-primary: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
            --bg-secondary: #0d1117;
            --bg-tertiary: #161b22;
            --bg-card: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #c9d1d9;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --accent-secondary: #1f6feb;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.5);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.5);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.6);
            --success-bg: #0d1117;
            --success-border: #3fb950;
            --success-text: #56d364;
            --error-bg: #0d1117;
            --error-border: #f85149;
            --error-text: #ff7b72;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .theme-selector {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .theme-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-btn.active {
            border-color: var(--accent-color);
            transform: scale(1.1);
        }

        .theme-light { background: linear-gradient(135deg, #f5f7fa, #c3cfe2); }
        .theme-dark { background: linear-gradient(135deg, #1a202c, #2d3748); }
        .theme-midnight { background: linear-gradient(135deg, #0d1117, #161b22); }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            text-align: center;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .tab.active {
            background: var(--accent-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .constraint-group {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }

        .constraint-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .result-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .result-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .result-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .result-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .batch-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .scenario-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .scenario-header h4 {
            font-weight: 600;
            color: var(--text-primary);
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: var(--success-bg);
            border: 1px solid var(--success-border);
            color: var(--success-text);
        }

        .status-error {
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            color: var(--error-text);
        }

        .loading {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .advanced-toggle {
            text-align: center;
            margin: 16px 0;
        }

        .advanced-toggle button {
            background: none;
            border: none;
            color: var(--accent-color);
            font-weight: 500;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .advanced-toggle button:hover {
            background: var(--bg-tertiary);
        }

        .advanced-results {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border-color);
        }

        .dimension-toggle {
            display: flex;
            gap: 16px;
            margin: 8px 0;
        }

        .dimension-toggle label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .main-grid { grid-template-columns: 1fr; gap: 16px; }
            .form-row { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .theme-selector { position: relative; top: 0; right: 0; margin-bottom: 16px; justify-content: center; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="theme-selector">
        <div class="theme-btn theme-light active" onclick="setTheme('light')" title="Light Theme"></div>
        <div class="theme-btn theme-dark" onclick="setTheme('dark')" title="Dark Theme"></div>
        <div class="theme-btn theme-midnight" onclick="setTheme('midnight')" title="Midnight Theme"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Professional Duct Calculator</h1>
            <p>Advanced HVAC Duct Sizing & Analysis Tool</p>
        </div>

        <div class="main-grid">
            <!-- Input Section -->
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è Input Parameters</h2>

                <div class="tabs">
                    <div class="tab active" onclick="switchTab('manual-tab')">Manual</div>
                    <div class="tab" onclick="switchTab('auto-tab')">Auto Size</div>
                    <div class="tab" onclick="switchTab('semi-auto-tab')">Semi-Auto</div>
                </div>

                <!-- Manual Tab -->
                <div id="manual-tab" class="tab-content active">
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="flowrate">Flow Rate</label>
                                <input type="number" id="flowrate" step="0.01" placeholder="500">
                            </div>
                            <div>
                                <label for="flowUnits">Units</label>
                                <select id="flowUnits">
                                    <option value="L/s" selected>L/s</option>
                                    <option value="m¬≥/s">m¬≥/s</option>
                                    <option value="CFM">CFM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="width">Width (mm)</label>
                                <input type="number" id="width" step="1" placeholder="250">
                            </div>
                            <div>
                                <label for="height">Height (mm)</label>
                                <input type="number" id="height" step="1" placeholder="200">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="temperature">Temperature (¬∞C)</label>
                                <input type="number" id="temperature" step="0.1" value="20">
                            </div>
                            <div>
                                <label for="material">Material</label>
                                <select id="material">
                                    <option value="Galvanized Steel">Galvanized Steel</option>
                                    <option value="Aluminum">Aluminum</option>
                                    <option value="Stainless Steel">Stainless Steel</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn" onclick="calculateSingle()">
                            <span id="calcLoadingIcon" class="loading" style="display: none;"></span>
                            Calculate
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
                    </div>
                </div>

                <!-- Auto Tab -->
                <div id="auto-tab" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="auto-flowrate">Flow Rate</label>
                                <input type="number" id="auto-flowrate" step="0.01" placeholder="500">
                            </div>
                            <div>
                                <label for="auto-flowUnits">Units</label>
                                <select id="auto-flowUnits">
                                    <option value="L/s" selected>L/s</option>
                                    <option value="m¬≥/s">m¬≥/s</option>
                                    <option value="CFM">CFM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="constraint-group">
                        <div class="constraint-title">‚ö° Constraints</div>
                        <div class="form-row">
                            <div>
                                <label for="max-velocity">Max Velocity (m/s)</label>
                                <input type="number" id="max-velocity" step="0.1" value="7.5">
                            </div>
                            <div>
                                <label for="aspect-ratio">Aspect Ratio</label>
                                <input type="number" id="aspect-ratio" step="0.1" value="1.5" min="1" max="4">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn" onclick="calculateAutoSize()">
                            <span id="autoCalcLoadingIcon" class="loading" style="display: none;"></span>
                            Find Optimal Size
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearAutoForm()">Clear</button>
                    </div>
                </div>

                <!-- Semi-Auto Tab -->
                <div id="semi-auto-tab" class="tab-content" style="display: none;">
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="semi-flowrate">Flow Rate</label>
                                <input type="number" id="semi-flowrate" step="0.01" placeholder="500">
                            </div>
                            <div>
                                <label for="locked-value">Fixed Dimension (mm)</label>
                                <input type="number" id="locked-value" step="1" value="300">
                            </div>
                        </div>
                    </div>

                    <div class="constraint-group">
                        <div class="constraint-title">üìê Lock Dimension</div>
                        <div class="dimension-toggle">
                            <label><input type="radio" name="locked-dimension" value="width" checked> Width</label>
                            <label><input type="radio" name="locked-dimension" value="height"> Height</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <button type="button" class="btn" onclick="calculateSemiAutoSize()">
                            <span id="semiAutoCalcLoadingIcon" class="loading" style="display: none;"></span>
                            Calculate Size
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearSemiAutoForm()">Clear</button>
                    </div>
                </div>

                <div id="statusMessage" class="status-message"></div>
            </div>

            <!-- Results Section -->
            <div class="card">
                <h2 class="card-title">üìä Results</h2>

                <div id="resultsContainer">
                    <p style="text-align: center; color: var(--text-muted); padding: 40px;">
                        Enter parameters and calculate to see results
                    </p>
                </div>

                <div class="advanced-toggle" id="advancedToggle" style="display: none;">
                    <button onclick="toggleAdvancedResults()">
                        Show Advanced Results ‚ñº
                    </button>
                </div>

                <div class="advanced-results" id="advancedResultsContainer"></div>

                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="exportResults()" id="exportBtn" disabled>
                        üìÑ Export CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Batch Section -->
        <div class="batch-section">
            <h2 class="card-title">üöÄ Batch Calculations</h2>
            
            <div id="scenariosContainer">
                <div class="scenario-card" data-scenario="0">
                    <div class="scenario-header">
                        <h4>Scenario 1</h4>
                        <button type="button" class="remove-btn" onclick="removeScenario(0)" style="display: none;">Remove</button>
                    </div>
                    <div class="form-row">
                        <input type="number" placeholder="Flow Rate" class="scenario-flowrate">
                        <input type="number" placeholder="Width (mm)" class="scenario-width">
                        <input type="number" placeholder="Height (mm)" class="scenario-height">
                        <input type="number" placeholder="Temperature (¬∞C)" class="scenario-temperature" value="20">
                    </div>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="addScenario()">+ Add Scenario</button>
                <button type="button" class="btn" onclick="runBatchCalculations()">
                    <span id="batchLoadingIcon" class="loading" style="display: none;"></span>
                    Run Batch
                </button>
            </div>
        </div>
    </div>

    <script>
        // Theme Management
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.theme-${theme}`).classList.add('active');
            localStorage.setItem('theme', theme);
        }

        // Load saved theme
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        });

        // Calculator Variables
        let scenarioCount = 1;
        let currentResults = null;
        let advancedResultsVisible = false;

        // Tab Management
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(tabId).style.display = 'block';
            
            const tabIndex = tabId === 'manual-tab' ? 0 : tabId === 'auto-tab' ? 1 : 2;
            document.querySelectorAll('.tab')[tabIndex].classList.add('active');
        }

        // Main Calculation Function
        async function calculateSingle() {
            const loadingIcon = document.getElementById('calcLoadingIcon');
            
            try {
                loadingIcon.style.display = 'inline-block';
                showStatus('Calculating...', 'info');

                const params = getFormParameters();
                
                if (!validateInputs(params)) {
                    showStatus('Please fill in all required fields.', 'error');
                    return;
                }

                const result = performCalculation(params);
                displaySingleResult(result);
                currentResults = result;
                showStatus('Calculation completed!', 'success');
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('advancedToggle').style.display = 'block';

            } catch (error) {
                console.error('Calculation error:', error);
                showStatus('Calculation failed. Please check inputs.', 'error');
            } finally {
                loadingIcon.style.display = 'none';
            }
        }

        // Auto Size Calculation
        async function calculateAutoSize() {
            const loadingIcon = document.getElementById('autoCalcLoadingIcon');
            
            try {
                loadingIcon.style.display = 'inline-block';
                showStatus('Finding optimal size...', 'info');

                const params = getAutoSizeParameters();
                
                if (!params.flowrate) {
                    showStatus('Please enter a flow rate.', 'error');
                    return;
                }

                const optimalDimensions = findOptimalDuctSize(params);
                
                // Apply to manual form
                document.getElementById('flowrate').value = params.flowrate;
                document.getElementById('flowUnits').value = params.flowUnits;
                document.getElementById('width').value = optimalDimensions.width;
                document.getElementById('height').value = optimalDimensions.height;
                
                switchTab('manual-tab');
                calculateSingle();
                
                showStatus('Optimal size found!', 'success');

            } catch (error) {
                showStatus('Auto sizing failed.', 'error');
            } finally {
                loadingIcon.style.display = 'none';
            }
        }

        // Semi-Auto Calculation
        async function calculateSemiAutoSize() {
            const loadingIcon = document.getElementById('semiAutoCalcLoadingIcon');
            
            try {
                loadingIcon.style.display = 'inline-block';
                showStatus('Calculating with fixed dimension...', 'info');

                const params = getSemiAutoSizeParameters();
                
                if (!params.flowrate || !params.lockedValue) {
                    showStatus('Please enter flow rate and fixed dimension.', 'error');
                    return;
                }

                const result = findSemiOptimalSize(params);
                
                // Apply to manual form
                document.getElementById('flowrate').value = params.flowrate;
                document.getElementById('width').value = result.width;
                document.getElementById('height').value = result.height;
                
                switchTab('manual-tab');
                calculateSingle();
                
                showStatus('Semi-auto sizing completed!', 'success');

            } catch (error) {
                showStatus('Semi-auto sizing failed.', 'error');
            } finally {
                loadingIcon.style.display = 'none';
            }
        }

        // Helper Functions
        function getFormParameters() {
            return {
                flowrate: parseFloat(document.getElementById('flowrate').value) || 0,
                width: parseFloat(document.getElementById('width').value) || 0,
                height: parseFloat(document.getElementById('height').value) || 0,
                temperature: parseFloat(document.getElementById('temperature').value) || 20,
                material: document.getElementById('material').value,
                flowUnits: document.getElementById('flowUnits').value
            };
        }

        function getAutoSizeParameters() {
            return {
                flowrate: parseFloat(document.getElementById('auto-flowrate').value) || 0,
                maxVelocity: parseFloat(document.getElementById('max-velocity').value) || 7.5,
                aspectRatio: parseFloat(document.getElementById('aspect-ratio').value) || 1.5,
                flowUnits: document.getElementById('auto-flowUnits').value
            };
        }

        function getSemiAutoSizeParameters() {
            return {
                flowrate: parseFloat(document.getElementById('semi-flowrate').value) || 0,
                lockedDimension: document.querySelector('input[name="locked-dimension"]:checked').value,
                lockedValue: parseFloat(document.getElementById('locked-value').value) || 0,
                flowUnits: 'L/s'
            };
        }

        function validateInputs(params) {
            return params.flowrate > 0 && params.width > 0 && params.height > 0;
        }

        function performCalculation(params) {
            // Convert flow rate to m¬≥/s if needed
            let flowRate = params.flowrate;
            switch(params.flowUnits) {
                case 'L/s':
                    flowRate = flowRate / 1000;
                    break;
                case 'CFM':
                    flowRate = flowRate * 0.000471947;
                    break;
            }

            // Convert dimensions to meters
            const width = params.width / 1000;
            const height = params.height / 1000;
            
            // Calculate cross-sectional area
            const area = width * height;
            
            // Calculate equivalent diameter
            const equivalentDiameter = (4 * area / (2 * (width + height))) * 1000;
            
            // Calculate velocity
            const velocity = flowRate / area;
            
            // Air density at given temperature
            const airDensity = 1.225 * (293.15 / (273.15 + params.temperature));
            
            // Calculate velocity pressure
            const velocityPressure = 0.5 * airDensity * Math.pow(velocity, 2);
            
            // Calculate Reynolds number
            const kinematicViscosity = 1.5e-5;
            const reynoldsNumber = velocity * (equivalentDiameter / 1000) / kinematicViscosity;
            
            // Determine flow type
            const flowType = reynoldsNumber > 4000 ? 'Turbulent' : reynoldsNumber > 2300 ? 'Transitional' : 'Laminar';
            
            // Calculate friction factor
            const roughness = 0.0015;
            const relativeRoughness = roughness / equivalentDiameter;
            let frictionFactor;
            
            if (reynoldsNumber > 4000) {
                frictionFactor = 0.25 / Math.pow(Math.log10(relativeRoughness/3.7 + 5.74/Math.pow(reynoldsNumber, 0.9)), 2);
            } else {
                frictionFactor = 64 / reynoldsNumber;
            }
            
            // Calculate pressure drop per meter
            const pressureDrop = frictionFactor * (airDensity * Math.pow(velocity, 2)) / (2 * (equivalentDiameter / 1000));

            return {
                input: params,
                output: {
                    equivalentDiameter: equivalentDiameter.toFixed(1),
                    averageVelocity: velocity.toFixed(2),
                    pressureDrop: pressureDrop.toFixed(2),
                    velocityPressure: velocityPressure.toFixed(2),
                    crossSectionalArea: (area * 1000000).toFixed(0),
                    reynoldsNumber: Math.round(reynoldsNumber),
                    flowType: flowType,
                    frictionFactor: frictionFactor.toFixed(4),
                    airDensity: airDensity.toFixed(3)
                }
            };
        }

        function findOptimalDuctSize(params) {
            let flowRateM3S = params.flowrate;
            if (params.flowUnits === 'L/s') {
                flowRateM3S = params.flowrate / 1000;
            } else if (params.flowUnits === 'CFM') {
                flowRateM3S = params.flowrate * 0.000471947;
            }
            
            const minArea = flowRateM3S / params.maxVelocity;
            let height = Math.sqrt(minArea / params.aspectRatio);
            let width = height * params.aspectRatio;
            
            const increment = 50;
            let heightMm = Math.ceil(height * 1000 / increment) * increment;
            let widthMm = Math.ceil(width * 1000 / increment) * increment;
            
            return {
                width: widthMm,
                height: heightMm
            };
        }

        function findSemiOptimalSize(params) {
            let flowRateM3S = params.flowrate;
            if (params.flowUnits === 'L/s') {
                flowRateM3S = params.flowrate / 1000;
            }
            
            const lockedDimM = params.lockedValue / 1000;
            const targetVelocity = 6; // m/s target
            const requiredArea = flowRateM3S / targetVelocity;
            
            let width, height;
            if (params.lockedDimension === 'width') {
                width = params.lockedValue;
                height = Math.round((requiredArea / lockedDimM) * 1000);
            } else {
                height = params.lockedValue;
                width = Math.round((requiredArea / lockedDimM) * 1000);
            }
            
            return { width, height };
        }

        function displaySingleResult(result) {
            const container = document.getElementById('resultsContainer');
            const output = result.output;

            container.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-label">Duct Size</div>
                        <div class="result-value">${result.input.width} √ó ${result.input.height} mm</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Velocity</div>
                        <div class="result-value">${output.averageVelocity} m/s</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Pressure Drop</div>
                        <div class="result-value">${output.pressureDrop} Pa/m</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Equivalent Diameter</div>
                        <div class="result-value">${output.equivalentDiameter} mm</div>
                    </div>
                </div>
            `;
            
            displayAdvancedResults(result);
        }

        function displayAdvancedResults(result) {
            const container = document.getElementById('advancedResultsContainer');
            const output = result.output;
            
            container.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <div class="result-label">Velocity Pressure</div>
                        <div class="result-value">${output.velocityPressure} Pa</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Cross-Sectional Area</div>
                        <div class="result-value">${output.crossSectionalArea} mm¬≤</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Reynolds Number</div>
                        <div class="result-value">${output.reynoldsNumber}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Flow Type</div>
                        <div class="result-value">${output.flowType}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Friction Factor</div>
                        <div class="result-value">${output.frictionFactor}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Air Density</div>
                        <div class="result-value">${output.airDensity} kg/m¬≥</div>
                    </div>
                </div>
            `;
        }

        function toggleAdvancedResults() {
            const container = document.getElementById('advancedResultsContainer');
            const button = document.querySelector('#advancedToggle button');
            
            advancedResultsVisible = !advancedResultsVisible;
            
            if (advancedResultsVisible) {
                container.style.display = 'block';
                button.innerHTML = 'Hide Advanced Results ‚ñ≤';
            } else {
                container.style.display = 'none';
                button.innerHTML = 'Show Advanced Results ‚ñº';
            }
        }

        function addScenario() {
            const container = document.getElementById('scenariosContainer');
            const scenarioDiv = document.createElement('div');
            scenarioDiv.className = 'scenario-card';
            scenarioDiv.setAttribute('data-scenario', scenarioCount);
            
            scenarioDiv.innerHTML = `
                <div class="scenario-header">
                    <h4>Scenario ${scenarioCount + 1}</h4>
                    <button type="button" class="remove-btn" onclick="removeScenario(${scenarioCount})">Remove</button>
                </div>
                <div class="form-row">
                    <input type="number" placeholder="Flow Rate" class="scenario-flowrate">
                    <input type="number" placeholder="Width (mm)" class="scenario-width">
                    <input type="number" placeholder="Height (mm)" class="scenario-height">
                    <input type="number" placeholder="Temperature (¬∞C)" class="scenario-temperature" value="20">
                </div>
            `;
            
            container.appendChild(scenarioDiv);
            scenarioCount++;
            updateRemoveButtons();
        }

        function removeScenario(index) {
            const scenario = document.querySelector(`[data-scenario="${index}"]`);
            if (scenario) {
                scenario.remove();
                updateRemoveButtons();
            }
        }

        function updateRemoveButtons() {
            const scenarios = document.querySelectorAll('.scenario-card');
            const removeButtons = document.querySelectorAll('.remove-btn');
            
            removeButtons.forEach(btn => {
                btn.style.display = scenarios.length > 1 ? 'block' : 'none';
            });
        }

        async function runBatchCalculations() {
            const loadingIcon = document.getElementById('batchLoadingIcon');
            
            try {
                loadingIcon.style.display = 'inline-block';
                showStatus('Running batch calculations...', 'info');

                const scenarios = [];
                const scenarioElements = document.querySelectorAll('.scenario-card');
                
                scenarioElements.forEach((element, index) => {
                    const flowrate = element.querySelector('.scenario-flowrate').value;
                    const width = element.querySelector('.scenario-width').value;
                    const height = element.querySelector('.scenario-height').value;
                    const temperature = element.querySelector('.scenario-temperature').value || 20;
                    
                    if (flowrate && width && height) {
                        scenarios.push({
                            name: `Scenario ${index + 1}`,
                            flowrate: parseFloat(flowrate),
                            width: parseFloat(width),
                            height: parseFloat(height),
                            temperature: parseFloat(temperature),
                            material: 'Galvanized Steel',
                            flowUnits: 'L/s'
                        });
                    }
                });

                if (scenarios.length === 0) {
                    showStatus('Please enter at least one complete scenario.', 'error');
                    return;
                }

                const results = scenarios.map(scenario => {
                    const result = performCalculation(scenario);
                    return { name: scenario.name, ...result };
                });

                displayBatchResults(results);
                currentResults = results;
                showStatus(`Batch completed! ${scenarios.length} scenarios processed.`, 'success');
                document.getElementById('exportBtn').disabled = false;

            } catch (error) {
                showStatus('Batch calculations failed.', 'error');
            } finally {
                loadingIcon.style.display = 'none';
            }
        }

        function displayBatchResults(results) {
            const container = document.getElementById('resultsContainer');
            
            let html = '<h3>Batch Results</h3>';
            results.forEach(result => {
                html += `
                    <div style="margin-bottom: 20px; padding: 16px; border: 1px solid var(--border-color); border-radius: 12px;">
                        <h4>${result.name}</h4>
                        <div class="results-grid">
                            <div class="result-card">
                                <div class="result-label">Size</div>
                                <div class="result-value">${result.input.width} √ó ${result.input.height} mm</div>
                            </div>
                            <div class="result-card">
                                <div class="result-label">Velocity</div>
                                <div class="result-value">${result.output.averageVelocity} m/s</div>
                            </div>
                            <div class="result-card">
                                <div class="result-label">Pressure Drop</div>
                                <div class="result-value">${result.output.pressureDrop} Pa/m</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function exportResults() {
            if (!currentResults) {
                showStatus('No results to export.', 'error');
                return;
            }

            try {
                let csvContent = '';
                
                if (Array.isArray(currentResults)) {
                    csvContent = 'Scenario,Flow Rate,Width,Height,Velocity,Pressure Drop\n';
                    currentResults.forEach(result => {
                        csvContent += `${result.name},${result.input.flowrate},${result.input.width},${result.input.height},${result.output.averageVelocity},${result.output.pressureDrop}\n`;
                    });
                } else {
                    csvContent = 'Parameter,Value\n';
                    csvContent += `Flow Rate,${currentResults.input.flowrate}\n`;
                    csvContent += `Width,${currentResults.input.width} mm\n`;
                    csvContent += `Height,${currentResults.input.height} mm\n`;
                    csvContent += `Velocity,${currentResults.output.averageVelocity} m/s\n`;
                    csvContent += `Pressure Drop,${currentResults.output.pressureDrop} Pa/m\n`;
                }

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `duct_calculations_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showStatus('Results exported successfully!', 'success');
            } catch (error) {
                showStatus('Export failed.', 'error');
            }
        }

        function clearForm() {
            document.getElementById('flowrate').value = '';
            document.getElementById('width').value = '';
            document.getElementById('height').value = '';
            document.getElementById('temperature').value = '20';
            clearResults();
        }

        function clearAutoForm() {
            document.getElementById('auto-flowrate').value = '';
            document.getElementById('max-velocity').value = '7.5';
            document.getElementById('aspect-ratio').value = '1.5';
            hideStatus();
        }

        function clearSemiAutoForm() {
            document.getElementById('semi-flowrate').value = '';
            document.getElementById('locked-value').value = '300';
            hideStatus();
        }

        function clearResults() {
            document.getElementById('resultsContainer').innerHTML = `
                <p style="text-align: center; color: var(--text-muted); padding: 40px;">
                    Enter parameters and calculate to see results
                </p>
            `;
            document.getElementById('exportBtn').disabled = true;
            document.getElementById('advancedToggle').style.display = 'none';
            currentResults = null;
            hideStatus();
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(hideStatus, 3000);
            }
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }
    </script>
</body>
</html>
